{{- define "ensure_authorized_keys" -}}
{{- if .AuthorizedKeys -}}
{{- $userEsc := shellEscape .Name -}}
home_dir=$(getent passwd {{ $userEsc }} | cut -d: -f6)
ssh_dir="$home_dir/{{ .SSHDirName }}"
auth_file="$ssh_dir/{{ .AuthFileName }}"
mkdir -p "$ssh_dir"
chmod {{ .SSHDirMode }} "$ssh_dir"
touch "$auth_file"
chmod {{ .AuthFileMode }} "$auth_file"
{{ range .AuthorizedKeys -}}
if ! grep -qxF {{ shellEscape . }} "$auth_file"; then
  printf '%s\n' {{ shellEscape . }} >> "$auth_file"
fi
{{ end -}}
chown -R {{ $userEsc }}:{{ $userEsc }} "$ssh_dir"
{{- end -}}
{{- end -}}
