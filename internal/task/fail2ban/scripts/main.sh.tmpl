{{- define "main" -}}
set -e

config_path={{ shellEscape .ConfigPath }}
config_dir=$(dirname "$config_path")
config_content={{ shellEscape .ConfigContent }}
service_name={{ shellEscape .ServiceName }}
client_cmd={{ shellEscape .ClientCmd }}

install_fail2ban() {
  if command -v apt-get >/dev/null 2>&1; then
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y
    apt-get install -y --no-install-recommends fail2ban
  elif command -v dnf >/dev/null 2>&1; then
    dnf install -y fail2ban
  elif command -v yum >/dev/null 2>&1; then
    yum install -y fail2ban
  elif command -v apk >/dev/null 2>&1; then
    apk add --no-cache fail2ban
  elif command -v pacman >/dev/null 2>&1; then
    pacman -Sy --noconfirm fail2ban
  else
    echo "no supported package manager found to install fail2ban" >&2
    exit 1
  fi
}

if ! command -v "$client_cmd" >/dev/null 2>&1; then
  install_fail2ban
fi

mkdir -p "$config_dir"
printf '%s' "$config_content" > "$config_path"

if command -v "$client_cmd" >/dev/null 2>&1; then
  "$client_cmd" -t
fi

started=0
if command -v systemctl >/dev/null 2>&1; then
  if systemctl enable "$service_name" >/dev/null 2>&1 && systemctl restart "$service_name" >/dev/null 2>&1; then
    started=1
  fi
fi

if [ "$started" -eq 0 ] && command -v service >/dev/null 2>&1; then
  service "$service_name" restart || service "$service_name" start || true
fi
{{- end -}}
